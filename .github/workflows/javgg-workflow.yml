name: JavaGG Complete Workflow

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      max_videos:
        description: 'Maximum videos to process (0 = unlimited)'
        required: false
        default: '0'
      force_run:
        description: 'Force run even if no changes'
        required: false
        default: 'false'
      skip_trigger:
        description: 'Skip auto-retrigger (one-shot mode)'
        required: false
        default: 'false'

# Prevent concurrent runs - critical for data integrity
concurrency:
  group: javgg-workflow
  cancel-in-progress: false

env:
  PYTHONUNBUFFERED: '1'
  GIO_MODULE_DIR: '/dev/null'

jobs:
  process-videos:
    runs-on: ubuntu-latest
    timeout-minutes: 330
    permissions:
      contents: write
      actions: write
    
    outputs:
      videos_processed: ${{ steps.workflow.outputs.videos_processed }}
      should_retrigger: ${{ steps.decide.outputs.should_retrigger }}
      exit_status: ${{ steps.workflow.outputs.exit_status }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Pull latest changes with retry
        id: git_pull
        run: |
          for i in 1 2 3; do
            if git pull origin main; then
              echo "pulled=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Pull failed, retrying in 5s..."
            sleep 5
          done
          echo "pulled=false" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Pre-flight checks
        run: |
          # Check disk space (need at least 5GB)
          AVAILABLE=$(df / | tail -1 | awk '{print $4}')
          if [ "$AVAILABLE" -lt 5242880 ]; then
            echo "‚ùå Insufficient disk space: ${AVAILABLE}KB available"
            exit 1
          fi
          echo "‚úÖ Disk space OK: ${AVAILABLE}KB available"
          
          # Ensure required directories exist
          mkdir -p database javgg logs
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /usr/local/bin/chromedriver
          key: deps-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            deps-${{ runner.os }}-
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Chrome (latest stable)
        run: |
          sudo apt-get update -qq
          
          # Use Google's official repo with signed-by (apt-key is deprecated)
          wget -qO- https://dl-ssl.google.com/linux/linux_signing_key.pub | \
            sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] \
            http://dl.google.com/linux/chrome/deb/ stable main" | \
            sudo tee /etc/apt/sources.list.d/google-chrome.list
          
          sudo apt-get update -qq
          sudo apt-get install -y -qq google-chrome-stable ffmpeg
          
          echo "Chrome version: $(google-chrome --version)"
      
      - name: Install matching ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+' | head -1)
          echo "Chrome major version: $CHROME_VERSION"
          
          # Fetch matching ChromeDriver
          DRIVER_VERSION=$(curl -fsSL \
            "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_VERSION}")
          
          if [ -z "$DRIVER_VERSION" ]; then
            echo "‚ùå Failed to get ChromeDriver version for Chrome $CHROME_VERSION"
            exit 1
          fi
          
          echo "ChromeDriver version: $DRIVER_VERSION"
          
          # Download and install
          curl -fsSL \
            "https://storage.googleapis.com/chrome-for-testing-public/${DRIVER_VERSION}/linux64/chromedriver-linux64.zip" \
            -o chromedriver.zip
          
          unzip -q chromedriver.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          rm -rf chromedriver-linux64 chromedriver.zip
          
          chromedriver --version
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Install with proper error handling
          pip install -r javgg/requirements.txt
          pip install -r tools/preview_generator/requirements.txt || echo "Optional requirements failed"
          pip install -r upload_pipeline/requirements.txt || echo "Optional requirements failed"
          pip install yt-dlp
      
      - name: Verify browser setup
        run: |
          python3 -c "
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          
          options = Options()
          options.add_argument('--headless=new')
          options.add_argument('--no-sandbox')
          options.add_argument('--disable-dev-shm-usage')
          
          driver = webdriver.Chrome(options=options)
          print(f'‚úÖ Browser: {driver.capabilities[\"browserVersion\"]}')
          driver.quit()
          "
      
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: Run workflow
        id: workflow
        env:
          MAX_VIDEOS: ${{ github.event.inputs.max_videos || '0' }}
        run: |
          cd javgg
          
          # Run with timeout, capture exit code properly
          timeout 5h python -u complete_workflow.py --max-videos "$MAX_VIDEOS" 2>&1 | tee ../logs/workflow.log
          EXIT_CODE=${PIPESTATUS[0]}
          
          # Parse results if available
          VIDEOS_PROCESSED=0
          if [ -f ../database/stats.json ]; then
            VIDEOS_PROCESSED=$(python3 -c "import json; d=json.load(open('../database/stats.json')); print(d.get('videos_processed_today', 0))" 2>/dev/null || echo 0)
          fi
          
          echo "videos_processed=$VIDEOS_PROCESSED" >> $GITHUB_OUTPUT
          echo "exit_status=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 124 ]; then
            echo "status=timeout" >> $GITHUB_OUTPUT
            echo "‚è±Ô∏è Timed out after 5 hours"
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "‚úÖ Completed successfully"
          else
            echo "status=error" >> $GITHUB_OUTPUT
            echo "‚ùå Failed with exit code $EXIT_CODE"
            exit 1
          fi
      
      - name: Validate database files
        run: |
          # Check JSON files are valid before committing
          for file in database/*.json; do
            if [ -f "$file" ]; then
              if ! python3 -c "import json; json.load(open('$file'))" 2>/dev/null; then
                echo "‚ùå Invalid JSON: $file"
                exit 1
              fi
            fi
          done
          echo "‚úÖ All database files are valid JSON"
      
      - name: Check for meaningful changes
        id: check_changes
        run: |
          git add database/ logs/ 2>/dev/null || true
          
          # Check if there are actual content changes (not just timestamps)
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "üì≠ No changes"
          else
            # Show what changed
            echo "üì¶ Changes detected:"
            git diff --staged --stat
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push with retry
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "Update: $(date '+%Y-%m-%d %H:%M:%S') [processed: ${{ steps.workflow.outputs.videos_processed }} videos]"
          
          # Retry push up to 3 times
          for i in 1 2 3; do
            if git push; then
              echo "‚úÖ Pushed successfully"
              exit 0
            fi
            echo "Push failed, pulling and retrying..."
            git pull --rebase origin main || true
            sleep 5
          done
          echo "‚ùå Failed to push after 3 attempts"
          exit 1
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            logs/
            database/*.json
            javgg/*.log
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Cleanup old artifacts
        if: always()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            // Delete artifacts older than 7 days to save space
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const oldArtifacts = artifacts.data.artifacts.filter(a => {
              const age = Date.now() - new Date(a.created_at).getTime();
              return age > 7 * 24 * 60 * 60 * 1000 && !a.expired;
            });
            
            for (const artifact of oldArtifacts.slice(0, 10)) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
              console.log(`Deleted old artifact: ${artifact.name}`);
            }
      
      - name: Decide on retrigger
        id: decide
        run: |
          # Don't retrigger if:
          # 1. Explicitly skipped
          # 2. No videos processed AND no changes AND not forced
          # 3. Exit status was error
          
          if [ "${{ github.event.inputs.skip_trigger }}" = "true" ]; then
            echo "should_retrigger=false" >> $GITHUB_OUTPUT
            echo "üö´ Retrigger skipped (manual)"
          elif [ "${{ steps.workflow.outputs.exit_status }}" != "0" ]; then
            echo "should_retrigger=false" >> $GITHUB_OUTPUT
            echo "üö´ Not retriggering due to error"
          elif [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "should_retrigger=true" >> $GITHUB_OUTPUT
            echo "üîÑ Retriggering (forced)"
          elif [ "${{ steps.workflow.outputs.videos_processed }}" -gt 0 ]; then
            echo "should_retrigger=true" >> $GITHUB_OUTPUT
            echo "üîÑ Retriggering (processed ${{ steps.workflow.outputs.videos_processed }} videos)"
          elif [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "should_retrigger=true" >> $GITHUB_OUTPUT
            echo "üîÑ Retriggering (has changes)"
          else
            echo "should_retrigger=false" >> $GITHUB_OUTPUT
            echo "üõë Not retriggering (no work done)"
          fi
      
      - name: Trigger next run
        if: steps.decide.outputs.should_retrigger == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Rate limit protection: max 10 triggers per hour
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.workflow,
              created: '>=' + new Date(Date.now() - 60*60*1000).toISOString(),
              per_page: 20
            });
            
            const recentTriggers = runs.data.workflow_runs.filter(r => 
              r.event === 'workflow_dispatch' && 
              new Date(r.created_at) > new Date(Date.now() - 60*60*1000)
            ).length;
            
            if (recentTriggers >= 10) {
              console.log('‚ö†Ô∏è Rate limit protection: too many recent triggers');
              return;
            }
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.workflow,
              ref: context.ref,
              inputs: {
                max_videos: '0',
                force_run: 'false',
                skip_trigger: 'false'
              }
            });
            console.log('‚úÖ Triggered next run');
