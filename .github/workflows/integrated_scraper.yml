name: Integrated Jable + JAVDatabase Scraper 24/7

permissions:
  contents: write
  actions: write

concurrency:
  group: scraper-${{ github.event_name == 'workflow_dispatch' && github.run_id || 'scheduled' }}
  cancel-in-progress: ${{ github.event_name == 'workflow_dispatch' }}

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes - more aggressive scheduling
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'scrape'
        options:
          - scrape
          - check-status
          - force-restart
          - update-databases
          - retry-javdb
      max_videos:
        description: 'Max videos to process (for scrape action)'
        required: false
        default: ''

jobs:
  determine-action:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_scrape: ${{ steps.decide.outputs.should_scrape }}
      should_update_db: ${{ steps.decide.outputs.should_update_db }}
      should_retry_javdb: ${{ steps.decide.outputs.should_retry_javdb }}
      reason: ${{ steps.decide.outputs.reason }}
    
    steps:
      - name: Decide action
        id: decide
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -e
          echo "=========================================="
          echo "DETERMINING ACTION"
          echo "=========================================="
          echo "Event: ${{ github.event_name }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Default values
          SHOULD_SCRAPE="false"
          SHOULD_UPDATE_DB="false"
          SHOULD_RETRY_JAVDB="false"
          REASON="Unknown"
          
          # Manual actions (workflow_dispatch)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            
            case "${{ github.event.inputs.action }}" in
              "scrape")
                SHOULD_SCRAPE="true"
                REASON="Manual scrape requested"
                ;;
              "force-restart")
                SHOULD_SCRAPE="true"
                REASON="Force restart requested"
                ;;
              "update-databases")
                SHOULD_UPDATE_DB="true"
                REASON="Database update requested"
                ;;
              "retry-javdb")
                SHOULD_RETRY_JAVDB="true"
                REASON="JAVDatabase retry requested"
                ;;
              "check-status")
                REASON="Status check only"
                ;;
              *)
                SHOULD_SCRAPE="true"
                REASON="Manual trigger (default action)"
                ;;
            esac
            
            echo "Manual action: ${{ github.event.inputs.action }}"
            echo "Decision: scrape=$SHOULD_SCRAPE, update_db=$SHOULD_UPDATE_DB, retry_javdb=$SHOULD_RETRY_JAVDB"
            
            echo "should_scrape=$SHOULD_SCRAPE" >> $GITHUB_OUTPUT
            echo "should_update_db=$SHOULD_UPDATE_DB" >> $GITHUB_OUTPUT
            echo "should_retry_javdb=$SHOULD_RETRY_JAVDB" >> $GITHUB_OUTPUT
            echo "reason=$REASON" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Scheduled run (cron)
          echo "Scheduled run - checking if scraper needs restart..."
          
          # Fetch recent workflow runs
          echo "Fetching workflow runs..."
          RUNS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/runs?per_page=20&status=completed,in_progress,queued" || echo "")
          
          if [ -z "$RUNS_JSON" ] || [ "$RUNS_JSON" = "null" ] || [ "$RUNS_JSON" = "" ]; then
            echo "âš ï¸ Could not fetch workflow runs - starting scraper"
            SHOULD_SCRAPE="true"
            REASON="Could not fetch runs (API error)"
            
            echo "should_scrape=$SHOULD_SCRAPE" >> $GITHUB_OUTPUT
            echo "should_update_db=$SHOULD_UPDATE_DB" >> $GITHUB_OUTPUT
            echo "should_retry_javdb=$SHOULD_RETRY_JAVDB" >> $GITHUB_OUTPUT
            echo "reason=$REASON" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for currently running scraper jobs
          echo "Checking for running jobs..."
          RUNNING_COUNT=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name == "Integrated Jable + JAVDatabase Scraper 24/7" and .id != ${{ github.run_id }}) | select(.status == "in_progress" or .status == "queued" or .status == "waiting")] | length' 2>/dev/null || echo "0")
          
          echo "Running jobs (excluding this one): $RUNNING_COUNT"
          
          if [ "$RUNNING_COUNT" -gt "0" ]; then
            echo "âœ“ Scraper is already running"
            REASON="Scraper already running ($RUNNING_COUNT jobs)"
            
            echo "should_scrape=$SHOULD_SCRAPE" >> $GITHUB_OUTPUT
            echo "should_update_db=$SHOULD_UPDATE_DB" >> $GITHUB_OUTPUT
            echo "should_retry_javdb=$SHOULD_RETRY_JAVDB" >> $GITHUB_OUTPUT
            echo "reason=$REASON" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # No running jobs - check when last job completed
          echo "No running jobs found - checking last completion time..."
          
          LATEST_COMPLETED=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name == "Integrated Jable + JAVDatabase Scraper 24/7" and .id != ${{ github.run_id }}) | select(.status == "completed")] | sort_by(.updated_at) | reverse | .[0] | .updated_at' 2>/dev/null || echo "")
          
          if [ -z "$LATEST_COMPLETED" ] || [ "$LATEST_COMPLETED" = "null" ] || [ "$LATEST_COMPLETED" = "" ]; then
            echo "âš ï¸ No completed runs found - starting scraper"
            SHOULD_SCRAPE="true"
            REASON="No completed runs found (first run or all failed)"
            
            echo "should_scrape=$SHOULD_SCRAPE" >> $GITHUB_OUTPUT
            echo "should_update_db=$SHOULD_UPDATE_DB" >> $GITHUB_OUTPUT
            echo "should_retry_javdb=$SHOULD_RETRY_JAVDB" >> $GITHUB_OUTPUT
            echo "reason=$REASON" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Last completed: $LATEST_COMPLETED"
          
          # Calculate time since last completion
          LAST_TIMESTAMP=$(date -d "$LATEST_COMPLETED" +%s 2>/dev/null || echo "0")
          CURRENT_TIMESTAMP=$(date +%s)
          
          if [ "$LAST_TIMESTAMP" = "0" ]; then
            echo "âš ï¸ Could not parse timestamp - starting scraper"
            SHOULD_SCRAPE="true"
            REASON="Could not parse timestamp"
            
            echo "should_scrape=$SHOULD_SCRAPE" >> $GITHUB_OUTPUT
            echo "should_update_db=$SHOULD_UPDATE_DB" >> $GITHUB_OUTPUT
            echo "should_retry_javdb=$SHOULD_RETRY_JAVDB" >> $GITHUB_OUTPUT
            echo "reason=$REASON" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          TIME_DIFF=$((CURRENT_TIMESTAMP - LAST_TIMESTAMP))
          MINUTES_SINCE=$((TIME_DIFF / 60))
          HOURS_SINCE=$((TIME_DIFF / 3600))
          
          echo "Time since last completion: ${MINUTES_SINCE} minutes (${HOURS_SINCE} hours)"
          
          # Auto-restart logic:
          # - If last run completed more than 10 minutes ago, restart
          # - This ensures continuous operation
          if [ $TIME_DIFF -gt 600 ]; then
            echo "âœ“ Last run completed ${MINUTES_SINCE} minutes ago - restarting"
            SHOULD_SCRAPE="true"
            REASON="Auto-restart: ${MINUTES_SINCE} minutes since last completion"
          else
            echo "âœ“ Recently completed (${MINUTES_SINCE} minutes ago) - no restart needed"
            REASON="Recently completed (${MINUTES_SINCE} minutes ago)"
          fi
          
          # EMERGENCY RESTART: If workflow has been idle for 2+ hours, force restart
          # This handles cases where GitHub Actions cron is delayed/skipped
          if [ $TIME_DIFF -gt 7200 ]; then
            echo "âš ï¸ EMERGENCY: Workflow idle for ${HOURS_SINCE} hours - forcing restart"
            SHOULD_SCRAPE="true"
            REASON="EMERGENCY: ${HOURS_SINCE} hours idle - forced restart"
          fi
          
          echo ""
          echo "=========================================="
          echo "DECISION"
          echo "=========================================="
          echo "Should scrape: $SHOULD_SCRAPE"
          echo "Reason: $REASON"
          echo "=========================================="
          
          echo "should_scrape=$SHOULD_SCRAPE" >> $GITHUB_OUTPUT
          echo "should_update_db=$SHOULD_UPDATE_DB" >> $GITHUB_OUTPUT
          echo "should_retry_javdb=$SHOULD_RETRY_JAVDB" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
  
  scrape-and-upload:
    needs: determine-action
    if: needs.determine-action.outputs.should_scrape == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Log start reason
        run: |
          echo "=========================================="
          echo "STARTING INTEGRATED SCRAPER"
          echo "=========================================="
          echo "Reason: ${{ needs.determine-action.outputs.reason }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "=========================================="
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y ffmpeg
          ffmpeg -version
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r jable/requirements.txt
          if [ -f javdatabase/requirements.txt ]; then
            pip install -r javdatabase/requirements.txt
          fi
          pip install filelock  # For database locking
      
      - name: Check disk space
        run: df -h
      
      - name: Create directories and initialize databases
        run: |
          mkdir -p jable/temp_downloads
          mkdir -p javdatabase/database
          mkdir -p database
          mkdir -p database/backups
          
          echo "=========================================="
          echo "CHECKING DATABASE FILES"
          echo "=========================================="
          
          # Create fresh database files if missing
          if [ ! -f database/combined_videos.json ]; then
            echo "ðŸ“ Creating new combined_videos.json..."
            echo "[]" > database/combined_videos.json
          else
            echo "âœ“ combined_videos.json exists"
          fi
          
          if [ ! -f database/failed_videos.json ]; then
            echo "ðŸ“ Creating new failed_videos.json..."
            echo "[]" > database/failed_videos.json
          else
            echo "âœ“ failed_videos.json exists"
          fi
          
          if [ ! -f database/hosting_status.json ]; then
            echo "ðŸ“ Creating new hosting_status.json..."
            echo "{}" > database/hosting_status.json
          else
            echo "âœ“ hosting_status.json exists"
          fi
          
          if [ ! -f database/progress_tracking.json ]; then
            echo "ðŸ“ Creating new progress_tracking.json..."
            echo '{"total_videos":0,"processed":0,"failed":0,"last_updated":""}' > database/progress_tracking.json
          else
            echo "âœ“ progress_tracking.json exists"
          fi
          
          if [ ! -f database/stats.json ]; then
            echo "ðŸ“ Creating new stats.json..."
            echo '{"total_videos":0,"total_size_gb":0,"hosting_providers":{},"last_updated":""}' > database/stats.json
          else
            echo "âœ“ stats.json exists"
          fi
          
          if [ ! -f database/javdb_retry_queue.json ]; then
            echo "ðŸ“ Creating new javdb_retry_queue.json..."
            echo "[]" > database/javdb_retry_queue.json
          else
            echo "âœ“ javdb_retry_queue.json exists"
          fi
          
          echo "=========================================="
      
      - name: Show current database status
        run: |
          echo "=========================================="
          echo "CURRENT DATABASE STATUS"
          echo "=========================================="
          python show_database_summary.py 2>/dev/null || python -c "from database_manager import db_manager; db_manager.print_status()"
      
      - name: Validate API keys
        continue-on-error: true
        env:
          STREAMWISH_API_KEY: ${{ secrets.STREAMWISH_API_KEY }}
          LULUSTREAM_API_KEY: ${{ secrets.LULUSTREAM_API_KEY }}
          STREAMTAPE_LOGIN: ${{ secrets.STREAMTAPE_LOGIN }}
          STREAMTAPE_API_KEY: ${{ secrets.STREAMTAPE_API_KEY }}
        run: |
          echo "Validating API keys..."
          [ -z "$STREAMWISH_API_KEY" ] && echo "âš ï¸ STREAMWISH_API_KEY not set" || echo "âœ“ StreamWish API key is set"
          [ -z "$LULUSTREAM_API_KEY" ] && echo "âš ï¸ LULUSTREAM_API_KEY not set" || echo "âœ“ LuluStream API key is set"
          [ -z "$STREAMTAPE_LOGIN" ] && echo "âš ï¸ STREAMTAPE_LOGIN not set" || echo "âœ“ StreamTape login is set"
      
      - name: Run integrated scraper
        env:
          MAX_VIDEOS: ${{ github.event.inputs.max_videos || '999999' }}
          STREAMTAPE_LOGIN: ${{ secrets.STREAMTAPE_LOGIN }}
          STREAMTAPE_API_KEY: ${{ secrets.STREAMTAPE_API_KEY }}
          LULUSTREAM_API_KEY: ${{ secrets.LULUSTREAM_API_KEY }}
          STREAMWISH_API_KEY: ${{ secrets.STREAMWISH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTIONS: 'true'
        run: |
          cd jable
          timeout 19000 python run_continuous.py 2>&1 | tee pipeline.log || {
            EXIT_CODE=$?
            echo "Scraper exited with code: $EXIT_CODE"
            if [ $EXIT_CODE -eq 124 ]; then
              echo "â±ï¸ Timeout reached (5h 15m) - this is expected"
            else
              echo "âš ï¸ Scraper exited unexpectedly"
            fi
          }
        continue-on-error: true
      
      - name: Update all database tracking files
        if: always()
        run: |
          echo "=========================================="
          echo "UPDATING DATABASE TRACKING FILES"
          echo "=========================================="
          python update_all_databases.py 2>/dev/null || python -c "from database_manager import db_manager; db_manager.update_progress(); db_manager.update_stats()"
      
      - name: Show final statistics
        if: always()
        run: |
          echo "=========================================="
          echo "FINAL STATISTICS"
          echo "=========================================="
          python show_database_summary.py 2>/dev/null || python -c "from database_manager import db_manager; db_manager.print_status()"
          
          echo ""
          echo "Database files:"
          ls -lh database/*.json 2>/dev/null || true
      
      - name: Emergency cleanup
        if: always()
        run: |
          echo "Cleaning up temporary files..."
          rm -rf jable/temp_downloads/* 2>/dev/null || true
          df -h
      
      - name: Commit and push results
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Pull latest changes first to avoid conflicts
          git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || true
          
          # Add all database files
          git add database/*.json 2>/dev/null || true
          git add javdatabase/database/*.json 2>/dev/null || true
          git add *.log jable/*.log 2>/dev/null || true
          
          if ! git diff --staged --quiet; then
            VIDEOS_COUNT=$(python -c "import json; print(len(json.load(open('database/combined_videos.json'))))" 2>/dev/null || echo "?")
            git commit -m "ðŸ¤– Auto-update: $(date -u '+%Y-%m-%d %H:%M:%S UTC') - ${VIDEOS_COUNT} videos"
            
            # Retry push up to 5 times with exponential backoff
            for i in {1..5}; do
              if git push; then
                echo "âœ… Push successful"
                break
              else
                echo "âš ï¸ Push failed, retrying ($i/5)..."
                sleep $((i * 2))
                git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || true
              fi
            done
          else
            echo "No changes to commit"
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-databases-${{ github.run_number }}
          path: |
            *.log
            jable/*.log
            database/*.json
            database/backups/
          retention-days: 7
  
  update-databases:
    needs: determine-action
    if: needs.determine-action.outputs.should_update_db == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Update all databases
        run: |
          echo "=========================================="
          echo "UPDATING ALL DATABASE FILES"
          echo "=========================================="
          python update_all_databases.py
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || true
          git add database/*.json
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“Š Database update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi
  
  retry-javdb:
    needs: determine-action
    if: needs.determine-action.outputs.should_retry_javdb == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r javdatabase/requirements.txt
      
      - name: Process JAVDatabase retry queue
        run: |
          echo "=========================================="
          echo "PROCESSING JAVDATABASE RETRY QUEUE"
          echo "=========================================="
          cd javdatabase
          python -c "from integrated_pipeline import process_javdb_retry_queue; process_javdb_retry_queue(max_videos=10, headless=True)"
      
      - name: Update databases
        run: python update_all_databases.py
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || true
          git add database/*.json
          if ! git diff --staged --quiet; then
            git commit -m "ðŸŽ­ JAVDatabase retry: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
          fi
  
  status-report:
    needs: determine-action
    if: |
      needs.determine-action.outputs.should_scrape == 'false' &&
      needs.determine-action.outputs.should_update_db == 'false' &&
      needs.determine-action.outputs.should_retry_javdb == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Report status
        run: |
          echo "=========================================="
          echo "NO ACTION NEEDED"
          echo "=========================================="
          echo "Reason: ${{ needs.determine-action.outputs.reason }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=========================================="
