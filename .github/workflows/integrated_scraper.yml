name: Integrated Jable + JAVDatabase Scraper 24/7

permissions:
  contents: write
  actions: write

concurrency:
  group: scraper-24-7
  cancel-in-progress: true

on:
  schedule:
    - cron: '0 */6 * * *'
    - cron: '*/10 * * * *'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'scrape'
        options:
          - scrape
          - check-status
          - force-restart
      max_videos:
        description: 'Max videos to process (for scrape action)'
        required: false
        default: ''

jobs:
  determine-action:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      should_scrape: ${{ steps.decide.outputs.should_scrape }}
      reason: ${{ steps.decide.outputs.reason }}
    
    steps:
      - name: Decide action
        id: decide
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Determining action..."
          
          if [ "${{ github.event.inputs.action }}" = "scrape" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Manual scrape requested" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${{ github.event.inputs.action }}" = "force-restart" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Force restart requested" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${{ github.event.inputs.action }}" = "check-status" ]; then
            echo "should_scrape=false" >> $GITHUB_OUTPUT
            echo "reason=Status check only" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CURRENT_MINUTE=$((10#$(date +%M)))
          CURRENT_HOUR=$((10#$(date +%H)))
          
          if [ "$CURRENT_MINUTE" -lt 5 ]; then
            if [ "$CURRENT_HOUR" -eq 0 ] || [ "$CURRENT_HOUR" -eq 6 ] || [ "$CURRENT_HOUR" -eq 12 ] || [ "$CURRENT_HOUR" -eq 18 ]; then
              echo "should_scrape=true" >> $GITHUB_OUTPUT
              echo "reason=Scheduled 6-hour run (${CURRENT_HOUR}:00)" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "Checking if scraper needs restart..."
          
          RUNS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/runs?per_page=15")
          
          if [ -z "$RUNS_JSON" ] || [ "$RUNS_JSON" = "null" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Could not fetch runs" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          RUNNING_COUNT=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name == "Integrated Jable + JAVDatabase Scraper 24/7") | select(.status == "in_progress" or .status == "queued" or .status == "waiting")] | length')
          
          if [ "$RUNNING_COUNT" -gt "0" ]; then
            echo "should_scrape=false" >> $GITHUB_OUTPUT
            echo "reason=Scraper already running ($RUNNING_COUNT jobs)" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_COMPLETED=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name == "Integrated Jable + JAVDatabase Scraper 24/7") | select(.status == "completed")] | .[0] | .updated_at' 2>/dev/null || echo "")
          
          if [ -z "$LATEST_COMPLETED" ] || [ "$LATEST_COMPLETED" = "null" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=No completed runs found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LAST_TIMESTAMP=$(date -d "$LATEST_COMPLETED" +%s 2>/dev/null || echo "0")
          if [ "$LAST_TIMESTAMP" = "0" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Could not parse timestamp" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CURRENT_TIMESTAMP=$(date +%s)
          TIME_DIFF=$((CURRENT_TIMESTAMP - LAST_TIMESTAMP))
          MINUTES_SINCE=$((TIME_DIFF / 60))
          
          if [ $TIME_DIFF -gt 300 ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Last completed ${MINUTES_SINCE} minutes ago" >> $GITHUB_OUTPUT
          else
            echo "should_scrape=false" >> $GITHUB_OUTPUT
            echo "reason=Recently completed (${MINUTES_SINCE} minutes ago)" >> $GITHUB_OUTPUT
          fi
  
  scrape-and-upload:
    needs: determine-action
    if: needs.determine-action.outputs.should_scrape == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Log start reason
        run: |
          echo "STARTING INTEGRATED SCRAPER"
          echo "Reason: ${{ needs.determine-action.outputs.reason }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r jable/requirements.txt
          pip install -r javdatabase/requirements.txt || echo "No separate requirements"
      
      - name: Check disk space
        run: df -h
      
      - name: Create directories
        run: |
          mkdir -p jable/temp_downloads jable/database javdatabase/database database
          [ ! -f jable/database/videos_complete.json ] && echo "[]" > jable/database/videos_complete.json
          [ ! -f database/combined_videos.json ] && echo "[]" > database/combined_videos.json
      
      - name: Validate API keys
        env:
          STREAMWISH_API_KEY: ${{ secrets.STREAMWISH_API_KEY }}
          LULUSTREAM_API_KEY: ${{ secrets.LULUSTREAM_API_KEY }}
          STREAMTAPE_LOGIN: ${{ secrets.STREAMTAPE_LOGIN }}
          STREAMTAPE_API_KEY: ${{ secrets.STREAMTAPE_API_KEY }}
        run: |
          echo "Validating API keys..."
          [ -z "$STREAMWISH_API_KEY" ] && echo "STREAMWISH_API_KEY required" && exit 1
          echo "StreamWish API key is set"
      
      - name: Run integrated scraper
        env:
          MAX_VIDEOS: ${{ github.event.inputs.max_videos || '999999' }}
          STREAMTAPE_LOGIN: ${{ secrets.STREAMTAPE_LOGIN }}
          STREAMTAPE_API_KEY: ${{ secrets.STREAMTAPE_API_KEY }}
          LULUSTREAM_API_KEY: ${{ secrets.LULUSTREAM_API_KEY }}
          STREAMWISH_API_KEY: ${{ secrets.STREAMWISH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTIONS: 'true'
        run: |
          cd jable
          python run_continuous.py 2>&1 | tee pipeline.log
        continue-on-error: true
      
      - name: Check statistics
        if: always()
        run: |
          echo "Integration Statistics"
          [ -f javdatabase/database/stats.json ] && cat javdatabase/database/stats.json | jq '.'
          ls -lh jable/database/*.json 2>/dev/null || true
          ls -lh database/*.json 2>/dev/null || true
      
      - name: Emergency cleanup
        if: always()
        run: |
          rm -rf jable/temp_downloads/*
          df -h
      
      - name: Commit and push results
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add jable/database/ javdatabase/database/ database/ *.log jable/*.log 2>/dev/null || true
          
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push || echo "Push failed"
          fi
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-databases-${{ github.run_number }}
          path: |
            *.log
            jable/*.log
            jable/database/
            javdatabase/database/
            database/
          retention-days: 7
  
  status-report:
    needs: determine-action
    if: needs.determine-action.outputs.should_scrape == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Report status
        run: |
          echo "NO ACTION NEEDED"
          echo "Reason: ${{ needs.determine-action.outputs.reason }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
