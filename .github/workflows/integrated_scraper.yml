name: Integrated Jable + JAVDatabase Scraper 24/7

# Enhanced workflow with JAVDatabase integration monitoring
# This is OPTIONAL - the existing workflow works fine!

permissions:
  contents: write
  actions: write

concurrency:
  group: scraper-24-7
  cancel-in-progress: true

on:
  schedule:
    # Main scraper: Run every 6 hours
    - cron: '0 */6 * * *'
    # Auto-restart check: Every 10 minutes
    - cron: '*/10 * * * *'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        default: 'scrape'
        options:
          - scrape
          - check-status
          - force-restart
      max_videos:
        description: 'Max videos to process (for scrape action)'
        required: false
        default: ''

jobs:
  # Job 1: Determine what to do (unchanged)
  determine-action:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      should_scrape: ${{ steps.decide.outputs.should_scrape }}
      reason: ${{ steps.decide.outputs.reason }}
    
    steps:
      - name: Decide action
        id: decide
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "ðŸ” Determining action..."
          
          if [ "${{ github.event.inputs.action }}" = "scrape" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Manual scrape requested" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${{ github.event.inputs.action }}" = "force-restart" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Force restart requested" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "${{ github.event.inputs.action }}" = "check-status" ]; then
            echo "should_scrape=false" >> $GITHUB_OUTPUT
            echo "reason=Status check only" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CURRENT_MINUTE=$((10#$(date +%M)))
          CURRENT_HOUR=$((10#$(date +%H)))
          
          # Check if it's a 6-hour scheduled time (0, 6, 12, 18)
          if [ "$CURRENT_MINUTE" -lt 5 ]; then
            if [ "$CURRENT_HOUR" -eq 0 ] || [ "$CURRENT_HOUR" -eq 6 ] || [ "$CURRENT_HOUR" -eq 12 ] || [ "$CURRENT_HOUR" -eq 18 ]; then
              echo "should_scrape=true" >> $GITHUB_OUTPUT
              echo "reason=Scheduled 6-hour run (${CURRENT_HOUR}:00)" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "Checking if scraper needs restart..."
          
          RUNS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/actions/runs?per_page=15")
          
          if [ -z "$RUNS_JSON" ] || [ "$RUNS_JSON" = "null" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Could not fetch runs" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          RUNNING_COUNT=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name == "Integrated Jable + JAVDatabase Scraper 24/7") | select(.status == "in_progress" or .status == "queued" or .status == "waiting")] | length')
          
          if [ "$RUNNING_COUNT" -gt "0" ]; then
            echo "should_scrape=false" >> $GITHUB_OUTPUT
            echo "reason=Scraper already running ($RUNNING_COUNT jobs)" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LATEST_COMPLETED=$(echo "$RUNS_JSON" | jq -r '[.workflow_runs[] | select(.name == "Integrated Jable + JAVDatabase Scraper 24/7") | select(.status == "completed")] | .[0] | .updated_at' 2>/dev/null || echo "")
          
          if [ -z "$LATEST_COMPLETED" ] || [ "$LATEST_COMPLETED" = "null" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=No completed runs found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LAST_TIMESTAMP=$(date -d "$LATEST_COMPLETED" +%s 2>/dev/null || echo "0")
          if [ "$LAST_TIMESTAMP" = "0" ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Could not parse timestamp" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CURRENT_TIMESTAMP=$(date +%s)
          TIME_DIFF=$((CURRENT_TIMESTAMP - LAST_TIMESTAMP))
          MINUTES_SINCE=$((TIME_DIFF / 60))
          
          if [ $TIME_DIFF -gt 300 ]; then
            echo "should_scrape=true" >> $GITHUB_OUTPUT
            echo "reason=Last completed ${MINUTES_SINCE} minutes ago" >> $GITHUB_OUTPUT
          else
            echo "should_scrape=false" >> $GITHUB_OUTPUT
            echo "reason=Recently completed (${MINUTES_SINCE} minutes ago)" >> $GITHUB_OUTPUT
          fi
  
  # Job 2: Run the integrated scraper
  scrape-and-upload:
    needs: determine-action
    if: needs.determine-action.outputs.should_scrape == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6h 0m (safe margin with 45min gap for cleanup)
    
    steps:
      - name: Log start reason
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ STARTING INTEGRATED SCRAPER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Reason: ${{ needs.determine-action.outputs.reason }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Integration: Jable + JAVDatabase"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version
      
      - name: Install Python dependencies
        run: |
          cd jable
          pip install --upgrade pip
          pip install -r requirements.txt
          cd ../javdatabase
          pip install -r requirements.txt || echo "No separate requirements for javdatabase"
      
      - name: Check disk space (before)
        run: |
          df -h
          echo "Available space:"
          df -h . | tail -1 | awk '{print $4}'
      
      - name: Create necessary directories
        run: |
          mkdir -p jable/temp_downloads
          mkdir -p jable/database
          mkdir -p javdatabase/database
          mkdir -p database
          if [ ! -f jable/database/videos_complete.json ]; then
            echo "[]" > jable/database/videos_complete.json
          fi
          if [ ! -f database/combined_videos.json ]; then
            echo "[]" > database/combined_videos.json
          fi
      
      - name: Validate API keys
        env:
          STREAMWISH_API_KEY: ${{ secrets.STREAMWISH_API_KEY }}
          LULUSTREAM_API_KEY: ${{ secrets.LULUSTREAM_API_KEY }}
          STREAMTAPE_LOGIN: ${{ secrets.STREAMTAPE_LOGIN }}
          STREAMTAPE_API_KEY: ${{ secrets.STREAMTAPE_API_KEY }}
        run: |
          echo "ðŸ”‘ Validating API keys..."
          
          # Check if required keys are set
          if [ -z "$STREAMWISH_API_KEY" ]; then
            echo "âŒ STREAMWISH_API_KEY not set (required)"
            exit 1
          fi
          echo "âœ“ STREAMWISH_API_KEY is set"
          
          if [ -z "$LULUSTREAM_API_KEY" ]; then
            echo "âš ï¸ LULUSTREAM_API_KEY not set (optional fallback)"
          else
            echo "âœ“ LULUSTREAM_API_KEY is set"
          fi
          
          if [ -z "$STREAMTAPE_LOGIN" ] || [ -z "$STREAMTAPE_API_KEY" ]; then
            echo "âš ï¸ STREAMTAPE credentials not set (optional fallback)"
          else
            echo "âœ“ STREAMTAPE credentials are set"
          fi
          
          # Test StreamWish API
          echo ""
          echo "Testing StreamWish API..."
          python3 -c "
import os
import sys
import requests

api_key = os.getenv('STREAMWISH_API_KEY')
try:
    response = requests.get(f'https://api.streamwish.com/api/account/info?key={api_key}', timeout=10)
    if response.status_code == 200:
        data = response.json()
        if data.get('status') == 200:
            print('âœ… StreamWish API key valid')
            print(f'   Account: {data.get(\"result\", {}).get(\"email\", \"N/A\")}')
            sys.exit(0)
        else:
            print(f'âŒ StreamWish API returned error: {data.get(\"msg\", \"Unknown error\")}')
            sys.exit(1)
    else:
        print(f'âŒ StreamWish API key invalid: HTTP {response.status_code}')
        sys.exit(1)
except Exception as e:
    print(f'âŒ StreamWish API test failed: {e}')
    sys.exit(1)
          "
          
          echo ""
          echo "âœ… API validation complete"
      
      - name: Run integrated scraper pipeline
        env:
          MAX_VIDEOS: ${{ github.event.inputs.max_videos || '999999' }}
          STREAMTAPE_LOGIN: ${{ secrets.STREAMTAPE_LOGIN }}
          STREAMTAPE_API_KEY: ${{ secrets.STREAMTAPE_API_KEY }}
          LULUSTREAM_API_KEY: ${{ secrets.LULUSTREAM_API_KEY }}
          STREAMWISH_API_KEY: ${{ secrets.STREAMWISH_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTIONS: 'true'
        run: |
          cd jable
          echo "Starting integrated scraper (Jable + JAVDatabase)..."
          echo "GitHub Repository: $GITHUB_REPOSITORY"
          echo "GitHub Token available: $([ -n "$GITHUB_TOKEN" ] && echo 'Yes' || echo 'No')"
          python run_continuous.py 2>&1 | tee pipeline.log
          echo "Pipeline completed with exit code: $?"
        continue-on-error: true
      
      - name: Check integration statistics
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š INTEGRATION STATISTICS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f javdatabase/database/stats.json ]; then
            echo "JAVDatabase Integration Stats:"
            cat javdatabase/database/stats.json | jq '.'
          else
            echo "No JAVDatabase stats available"
          fi
          
          echo ""
          echo "Database Files:"
          ls -lh jable/database/*.json 2>/dev/null || echo "No Jable database"
          ls -lh database/*.json 2>/dev/null || echo "No combined database"
          
          if [ -f database/combined_videos.json ]; then
            COMBINED_COUNT=$(cat database/combined_videos.json | jq 'length' 2>/dev/null || echo "0")
            JAVDB_COUNT=$(cat database/combined_videos.json | jq '[.[] | select(.javdb_available == true)] | length' 2>/dev/null || echo "0")
            echo ""
            echo "Combined Database:"
            echo "  Total videos: $COMBINED_COUNT"
            echo "  With JAVDatabase: $JAVDB_COUNT"
            if [ "$COMBINED_COUNT" -gt 0 ]; then
              COVERAGE=$((JAVDB_COUNT * 100 / COMBINED_COUNT))
              echo "  Coverage: ${COVERAGE}%"
            fi
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Check disk space (after)
        if: always()
        run: |
          df -h
          echo "Temp folder size:"
          du -sh jable/temp_downloads/ || echo "No temp folder"
      
      - name: Emergency cleanup
        if: always()
        run: |
          echo "Cleaning up temp files..."
          rm -rf jable/temp_downloads/*
          rm -rf jable/temp_downloads/.*_segments 2>/dev/null || true
          df -h
      
      - name: Commit and push results
        if: always()
        run: |
          # Use trap to handle cancellation
          trap 'echo "âš ï¸ Caught cancellation signal"; git stash push -m "Auto-stash: $(date -u +%Y-%m-%d_%H:%M:%S)" 2>/dev/null || true; exit 0' SIGTERM SIGINT
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "Checking for changes..."
          git status
          
          # Check for uncommitted changes
          if ! git diff --quiet || ! git diff --staged --quiet; then
            echo "ðŸ“ Uncommitted changes detected"
            
            # Stash changes first as backup
            git stash push -m "Auto-stash: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" 2>/dev/null || true
            echo "âœ“ Changes stashed as backup"
            
            # Try to commit stashed changes
            git stash pop 2>/dev/null || true
          fi
          
          echo "Adding database folders..."
          git add jable/database/ 2>/dev/null || echo "No jable database"
          git add javdatabase/database/ 2>/dev/null || echo "No javdatabase database"
          git add database/ 2>/dev/null || echo "No combined database"
          
          echo "Adding log files..."
          git add *.log 2>/dev/null || echo "No log files"
          git add jable/*.log 2>/dev/null || echo "No jable logs"
          
          echo "Staged changes:"
          git diff --staged --name-only
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Committing changes..."
            git commit -m "Auto-update: $(date -u '+%Y-%m-%d %H:%M:%S UTC') [Integrated]" || echo "Commit failed"
            
            echo "Pushing to repository..."
            git push || echo "âš ï¸ Push failed, changes are committed locally"
            
            echo "âœ… Database updated and pushed!"
          fi
      
      - name: Upload logs and databases as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-databases-${{ github.run_number }}
          path: |
            *.log
            jable/*.log
            jable/database/
            javdatabase/database/
            database/
          retention-days: 7
      
      - name: Enhanced summary
        if: always()
        run: |
          echo "# Integrated Scraper Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ needs.determine-action.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f jable/database/videos_complete.json ]; then
            JABLE_COUNT=$(python -c "import json; print(len(json.load(open('jable/database/videos_complete.json'))))" 2>/dev/null || echo "0")
            echo "**Jable Videos:** $JABLE_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f database/combined_videos.json ]; then
            COMBINED_COUNT=$(python -c "import json; print(len(json.load(open('database/combined_videos.json'))))" 2>/dev/null || echo "0")
            JAVDB_COUNT=$(python -c "import json; data=json.load(open('database/combined_videos.json')); print(len([v for v in data if v.get('javdb_available')]))" 2>/dev/null || echo "0")
            echo "**Combined Videos:** $COMBINED_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**With JAVDatabase:** $JAVDB_COUNT" >> $GITHUB_STEP_SUMMARY
            if [ "$COMBINED_COUNT" -gt 0 ]; then
              COVERAGE=$((JAVDB_COUNT * 100 / COMBINED_COUNT))
              echo "**Coverage:** ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ -f javdatabase/database/stats.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸŽ­ JAVDatabase Integration" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat javdatabase/database/stats.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ’¾ Disk Usage" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          df -h . >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
  
  # Job 3: Status report (when scraper doesn't run)
  status-report:
    needs: determine-action
    if: needs.determine-action.outputs.should_scrape == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Report status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â„¹ï¸ NO ACTION NEEDED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Reason: ${{ needs.determine-action.outputs.reason }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Summary
        run: |
          echo "# Status Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** No action needed" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ needs.determine-action.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Main scraper: Every 6 hours" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-restart check: Every 10 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Restart delay: 5 minutes after completion" >> $GITHUB_STEP_SUMMARY
          echo "- Integration: Jable + JAVDatabase" >> $GITHUB_STEP_SUMMARY
